<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>都市掌握</title>

    <!-- Leaflet.jsのCSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet.markercluster (点の密集を防ぐ) のCSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        /* 基本スタイル */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }
        #map {
            width: 100%;
            height: 100%;
        }

        /* --- 検索ボックスのスタイル (PC) --- */
        #search-container {
            position: absolute;
            top: 10px;
            left: 53px;
            z-index: 1000;
            display: flex;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            background-clip: padding-box;
            background-color: #fff;
            height: 30px;
        }
        #search-input {
            border: none;
            padding: 0 10px;
            border-radius: 4px 0 0 4px;
            outline: none;
            width: 200px;
            background: transparent;
        }
        #search-button {
            height: 30px;
            width: 50px;
            border: none;
            border-left: 1px solid #ccc;
            border-radius: 0 4px 4px 0;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
        }
        #search-button:hover {
            background-color: #f4f4f4;
        }

        /* --- ライトモードのスタイル --- */
        body { background-color: #fff; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: white; color: #333; }
        .leaflet-tooltip { background: rgba(255, 255, 255, 0.9); border: 1px solid #ccc; color: #333; }
        .leaflet-control-layers, .leaflet-control-zoom a, .leaflet-control-attribution { background-color: #fff; color: #333; }
        .leaflet-control-layers-separator { border-top: 1px solid #ddd; }

        /* --- ダークモードのスタイル --- */
        body.dark-mode { background-color: #222; }
        .dark-mode .leaflet-tile-pane { filter: invert(1) grayscale(1) brightness(.8) contrast(1.2); }
        .dark-mode .leaflet-popup-content-wrapper, .dark-mode .leaflet-popup-tip { background: #2b2b2b; color: #f1f1f1; box-shadow: 0 3px 14px rgba(0,0,0,0.4); }
        .dark-mode .leaflet-tooltip { background: rgba(40, 40, 40, 0.9); border: 1px solid #555; color: #f1f1f1; }
        .dark-mode .leaflet-tooltip-top:before { border-top-color: #282828; }
        .dark-mode .leaflet-tooltip-bottom:before { border-bottom-color: #282828; }
        .dark-mode .leaflet-tooltip-left:before { border-left-color: #282828; }
        .dark-mode .leaflet-tooltip-right:before { border-right-color: #282828; }
        
        /* UIコントロール */
        .dark-mode .leaflet-control-layers, .dark-mode .leaflet-control-attribution { background-color: #2b2b2b; color: #f1f1f1; border-color: #555; }
        .dark-mode .leaflet-control-layers-selector, .dark-mode .leaflet-control-layers label { color: #f1f1f1; }
        .dark-mode .leaflet-control-layers-separator { border-top: 1px solid #555; }
        
        .dark-mode .leaflet-control-zoom {
            border: 2px solid #555;
            border-radius: 4px;
        }
        .dark-mode .leaflet-control-zoom a {
            background-color: #2b2b2b;
            color: #f1f1f1;
            border: none;
        }
        .dark-mode .leaflet-control-zoom a+a {
            border-top: 1px solid #555;
        }
        
        /* 検索ボックスのダークモード */
        .dark-mode #search-container { background-color: #2b2b2b; border-color: #555; }
        .dark-mode #search-input { color: #f1f1f1; }
        .dark-mode #search-button { color: #f1f1f1; border-left-color: #555; }
        .dark-mode #search-button:hover { background-color: #3c3c3c; }

        /* ポップアップとツールチップの共通スタイル */
        .leaflet-popup-content-wrapper { border-radius: 5px; padding-left: 0; padding-top: 6px; text-align: center; }
        .leaflet-popup-content { margin: 10px 15px; font-size: 14px; line-height: 1.6; }
        .leaflet-tooltip { border-radius: 3px; padding: 2px 5px; font-size: 12px; box-shadow: none; }
        
        /* コントロールパネルのレイアウト調整 */
        .leaflet-control-layers-base label { padding-left: 6px; }
        #dark-mode-section { padding: 6px 10px 6px 6px; display: flex; align-items: center; }
        .leaflet-control-layers-separator { margin: 4px 0; }

        /* --- レスポンシブ対応 (スマホ) --- */
        @media (max-width: 768px) {
            #search-container {
                top: auto;
                left: auto;
                bottom: 30px;
                right: 10px;
            }
            #search-input {
                width: 150px;
            }
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="search-container">
        <input type="text" id="search-input" placeholder="都市名を検索...">
        <button id="search-button">検索</button>
    </div>

    <!-- ライブラリと都市データの読み込み -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="cities.js"></script>

    <script>
        // 1. 地図の初期設定
        const baseMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        });
        const map = L.map('map', { layers: [baseMap] }).setView([30, 40], 3);

        map.on('click', () => map.closePopup());

        // 2. 都市の点とラベルのレイヤーを作成
        const layerGroups = {
            noLabel: L.markerClusterGroup({ maxClusterRadius: 40 }),
            oldestLabel: L.markerClusterGroup({ maxClusterRadius: 40 }),
            newestLabel: L.markerClusterGroup({ maxClusterRadius: 40 })
        };
        
        const popupOptions = {
            closeButton: false
        };

        cities.forEach(city => {
            const { historicalNames, lat, lng } = city;
            const namesCount = historicalNames.length;
            const color = namesCount >= 3 ? 'red' : (namesCount === 2 ? 'blue' : 'black');
            const markerOptions = { radius: 7, fillColor: color, color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.9, weight: 10, color: 'transparent', namesCount: namesCount };
            const popupContent = historicalNames.join('<br>');
            
            const markerNoLabel = L.circleMarker([lat, lng], markerOptions).bindPopup(popupContent, popupOptions);
            const markerOldest = L.circleMarker([lat, lng], markerOptions).bindPopup(popupContent, popupOptions).bindTooltip(historicalNames[0], { permanent: true, direction: 'top', offset: [0, -7], className: 'leaflet-tooltip' });
            const markerNewest = L.circleMarker([lat, lng], markerOptions).bindPopup(popupContent, popupOptions).bindTooltip(historicalNames[historicalNames.length - 1], { permanent: true, direction: 'top', offset: [0, -7], className: 'leaflet-tooltip' });
            
            [markerNoLabel, markerOldest, markerNewest].forEach(addMarkerEvents);

            layerGroups.noLabel.addLayer(markerNoLabel);
            layerGroups.oldestLabel.addLayer(markerOldest);
            layerGroups.newestLabel.addLayer(markerNewest);
        });
        map.addLayer(layerGroups.noLabel);

        // 3. UIコントロール
        const baseLayers = { "ラベルなし": layerGroups.noLabel, "最古の名称": layerGroups.oldestLabel, "最新の名称": layerGroups.newestLabel };
        const layersControl = L.control.layers(baseLayers, null, { collapsed: false }).addTo(map);

        const controlContainer = layersControl.getContainer();
        const separator = document.createElement('div');
        separator.className = 'leaflet-control-layers-separator';
        controlContainer.prepend(separator);

        const darkModeContainer = document.createElement('div');
        darkModeContainer.id = 'dark-mode-section';
        darkModeContainer.innerHTML = `<input type="checkbox" id="dark-mode-toggle" style="margin-right: 5px; margin-left: 4px;"><label for="dark-mode-toggle">ダークモード</label>`;
        controlContainer.prepend(darkModeContainer);

        // 4. イベントリスナー
        document.getElementById('dark-mode-toggle').addEventListener('change', function(e) {
            document.body.classList.toggle('dark-mode', e.target.checked);
            const isDark = e.target.checked;
            Object.values(layerGroups).forEach(group => {
                group.eachLayer(layer => {
                    if (layer.options.namesCount === 1) {
                        layer.setStyle({ fillColor: isDark ? '#cccccc' : 'black' });
                    }
                });
            });
        });

        // 検索機能
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        function searchCity() {
            const query = searchInput.value.toLowerCase().trim();
            if (!query) return;
            const foundCity = cities.find(city => city.historicalNames.some(name => name.toLowerCase().includes(query)));

            if (foundCity) {
                const { lat, lng, historicalNames } = foundCity;
                map.flyTo([lat, lng], 5);
                L.popup(popupOptions).setLatLng([lat, lng]).setContent(historicalNames.join('<br>')).openOn(map);
            } else {
                alert('都市が見つかりませんでした。');
            }
        }
        searchButton.addEventListener('click', searchCity);
        searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { searchCity(); }});

        // マウスホバーとクリックのイベントを管理する関数
        function addMarkerEvents(marker) {
            let closeTimeout; let isClicked = false;
            function openPopupWithLogic() { clearTimeout(closeTimeout); marker.openPopup(); }
            function closePopupWithLogic() { closeTimeout = setTimeout(() => { if (!isClicked) { marker.closePopup(); } }, 100); }
            marker.on('mouseover', openPopupWithLogic); marker.on('mouseout', closePopupWithLogic);
            marker.on('popupopen', function () { this.getPopup().getElement().addEventListener('mouseover', openPopupWithLogic); this.getPopup().getElement().addEventListener('mouseout', closePopupWithLogic); });
            marker.on('click', (e) => {
                isClicked = true;
                openPopupWithLogic();
                L.DomEvent.stop(e);
            });
            marker.on('popupclose', () => { isClicked = false; });
        }
    </script>
</body>
</html>